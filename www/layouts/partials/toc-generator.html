{{/* 
  Reusable Table of Contents Generator
  Params:
  - sectionName: The section name (e.g. "documentation", "articles")
  - currentPage: The current page context
*/}}

{{ $currentPage := .currentPage }}
{{ $sectionName := .sectionName }}
{{ $section := .currentPage.Site.GetPage "section" $sectionName }}
{{ $pages := $section.Pages }}

<!-- Generate ToC structure -->
{{ $tocData := dict }}
{{ $tocOrder := slice }}
{{ $isIndexPage := eq .currentPage.Kind "section" }}
{{ $firstPageSet := false }}

{{ range $pages }}
  {{ $pathParts := split .File.Path "/" }}
  {{ if eq (len $pathParts) 2 }}
    {{ $fileName := index $pathParts 1 }}
    {{ $fileNameWithoutExt := strings.TrimSuffix $fileName ".md" }}
    {{ $tocOrder = $tocOrder | append (dict "type" "file" "name" $fileNameWithoutExt "page" . "order" $fileName) }}
  {{ else if eq (len $pathParts) 3 }}
    {{ $categoryName := index $pathParts 1 }}
    {{ $fileName := index $pathParts 2 }}
    {{ $fileNameWithoutExt := strings.TrimSuffix $fileName ".md" }}
    
    {{ if not (index $tocData $categoryName) }}
      {{ $tocData = merge $tocData (dict $categoryName (slice)) }}
      {{ $tocOrder = $tocOrder | append (dict "type" "category" "name" $categoryName "order" $categoryName) }}
    {{ end }}
    
    {{ $categoryPages := index $tocData $categoryName }}
    {{ $categoryPages = $categoryPages | append . }}
    {{ $tocData = merge $tocData (dict $categoryName $categoryPages) }}
  {{ end }}
{{ end }}

<!-- Sort tocOrder -->
{{ $tocOrder = sort $tocOrder "order" }}

<!-- Render ToC -->
{{ range $index, $item := $tocOrder }}
  {{ if eq .type "file" }}
    <!-- Single file -->
    {{ $isCurrentOrFirst := or (eq $currentPage .page) (and $isIndexPage (eq $index 0)) }}
    <div class="mb-2">
      <a 
        href="{{ .page.Permalink }}" 
        class="toc-link block px-3 py-2 text-sm font-medium {{ if $isCurrentOrFirst }}text-blue-600 bg-blue-50{{ else }}text-gray-900 hover:text-blue-600 hover:bg-gray-100{{ end }} rounded-md -ml-3"
        {{ if $isCurrentOrFirst }}aria-current="page"{{ end }}
      >
        {{ .page.LinkTitle }}
      </a>
    </div>
  {{ else if eq .type "category" }}
    <!-- Category with files -->
    {{ $categoryName := .name }}
    {{ $categoryPages := index $tocData $categoryName }}
    {{ $categoryTitle := $categoryName | replaceRE "^[0-9]+-" "" | replaceRE "-" " " | title }}
    
    <div class="mb-4">
      <h3 class="text-sm font-medium text-gray-900 mb-2">{{ $categoryTitle }}</h3>
      <ul class="space-y-1">
        {{ range sort $categoryPages ".File.Path" }}
          <li>
            <a 
              href="{{ .Permalink }}" 
              class="toc-link block px-3 py-2 text-sm {{ if eq $currentPage . }}text-blue-600 bg-blue-50 font-medium{{ else }}text-gray-700 hover:text-blue-600 hover:bg-gray-100{{ end }} rounded-md"
              {{ if eq $currentPage . }}aria-current="page"{{ end }}
            >
              {{ .LinkTitle }}
            </a>
          </li>
        {{ end }}
      </ul>
    </div>
  {{ end }}
{{ end }}